// Generated by CoffeeScript 1.10.0
var Client, cozydb, urlHelper;

cozydb = require('cozydb');

Client = require('request-json').JsonClient;

urlHelper = require('cozy-url-sdk');

module.exports.sendShareInvitations = function(event, callback) {
  var client, data, guests, needSaving;
  guests = event.toJSON().attendees;
  needSaving = false;
  data = {
    desc: event.description,
    rules: [
      {
        id: event.id,
        docType: 'event'
      }
    ],
    targets: [],
    continuous: true
  };
  guests.forEach(function(guest) {
    if (guest.status === 'INVITATION-NOT-SENT' && guest.shareWithCozy) {
      data.targets.push({
        recipientUrl: guest.cozy
      });
      guest.status = "NEEDS-ACTION";
      return needSaving = true;
    }
  });
  client = new Client(urlHelper.dataSystem.url());
  return client.post("services/sharing/", data, function(err, res, body) {
    if (err != null) {
      return callback(err);
    } else if (!needSaving) {
      return callback();
    } else {
      return event.updateAttributes({
        attendees: guests
      }, callback);
    }
  });
};
